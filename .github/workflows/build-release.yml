name: Build and Release APK

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'
          
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          # flutter-version: '3.29.3'
          channel: 'stable'
          cache: true
          
      - name: Get dependencies
        run: flutter pub get
        
      - name: Build APK - Split per ABI
        run: flutter build apk --release --split-per-abi
        
      - name: Rename APK files
        run: |
          mkdir -p output
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk output/ZedSecure-v${{ github.ref_name }}-arm64-v8a.apk
          cp build/app/outputs/flutter-apk/app-armeabi-v7a-release.apk output/ZedSecure-v${{ github.ref_name }}-armeabi-v7a.apk
          ls -lh output/
          
      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi
          
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: Zed-Secure v${{ steps.get_version.outputs.VERSION }}
          body: |
            ## 🎉 Zed-Secure VPN v${{ steps.get_version.outputs.VERSION }}
            
            ### 📥 Download APK
            
            Choose the APK for your device:
            
            | Architecture | Recommended For | File Size |
            |--------------|----------------|-----------|
            | **ARM64** | Most modern Android devices (2019+) | ~70-90 MB |
            | **ARMv7** | Older devices (2015-2019) | ~70-90 MB |
            
            ### ✨ Features
            
            - 🔒 **Multi-Protocol Support**: VMess, VLESS, Trojan, Shadowsocks
            - 🌐 **Transport Types**: TCP, WebSocket, HTTP/2, gRPC, QUIC
            - 📊 **Real-time Stats**: Upload/Download speed, connection time
            - 🎯 **Per-App Proxy**: Route specific apps through VPN
            - 🔄 **Auto-Update**: Subscription management with auto-refresh
            - ⚡ **Server Testing**: Ping all servers and auto-sort by latency
            - 📱 **Modern UI**: Microsoft Fluent Design with Glassmorphism
            - 📋 **Quick Import**: Copy config and paste directly
            
            ### 📋 System Requirements
            
            - **Android**: 7.0 (Nougat) or higher (API 24+)
            - **Storage**: 50-100 MB free space
            - **RAM**: 2 GB recommended
            
            ### 🚀 Installation
            
            1. Download the appropriate APK for your device
            2. Enable "Install from Unknown Sources" in Android settings
            3. Open the APK file and install
            4. Grant VPN permission when prompted
            
            ### 📖 Quick Start
            
            1. Open Zed-Secure
            2. Go to **Subscriptions** tab
            3. Activate the **Suggested Subscription** or add your own
            4. Go to **Servers** tab
            5. Select a server (tap the radio button)
            6. Go to **Home** and tap **Connect**
            
            ### 🐛 Bug Reports
            
            Found an issue? [Report it here](https://github.com/${{ github.repository }}/issues)
            
            ### 📝 Changelog
            
            See all changes: [Full Changelog](https://github.com/${{ github.repository }}/commits/v${{ steps.get_version.outputs.VERSION }})
            
            ---
            
            **⭐ If you find this app useful, please star the repository!**
          draft: false
          prerelease: false
          files: |
            output/*.apk
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apk-builds-v${{ steps.get_version.outputs.VERSION }}
          path: output/*.apk
          retention-days: 90
